# ─── GVH Command Center — AFFiNE + NocoDB with cross-navigation ────
# AFFiNE:  https://franwatch.com/          (port 443)
# NocoDB:  https://franwatch.com:8443/     (port 8443)

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# ─── HTTP → HTTPS redirect ───────────────────────────────────────────
server {
    listen 80;
    server_name _;
    return 301 https://franwatch.com$request_uri;
}

# ─── AFFiNE (HTTPS 443) ─────────────────────────────────────────────
server {
    listen 443 ssl;
    server_name _;
    client_max_body_size 100m;

    ssl_certificate /etc/letsencrypt/live/franwatch.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/franwatch.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;
    proxy_set_header Accept-Encoding "";
    sub_filter_once on;
    sub_filter_types text/html;

    sub_filter '</head>' '<script>
    (function(){
      function injectSidebarBtn(){
        if(document.getElementById("gvh-db-btn"))return;
        var sidebar=document.querySelector("[data-testid=\\"app-sidebar\\"]")||document.querySelector("nav");
        if(!sidebar)return;
        var anchor=null;
        var items=sidebar.querySelectorAll("a,div[role=\\"button\\"],button");
        for(var i=0;i<items.length;i++){
          var t=items[i].textContent.trim();
          if(t==="All docs"){anchor=items[i];break;}
        }
        if(!anchor)return;
        var btn=anchor.cloneNode(true);
        btn.id="gvh-db-btn";
        btn.removeAttribute("href");
        btn.style.cursor="pointer";
        var svgEl=btn.querySelector("svg");
        if(svgEl){svgEl.outerHTML="<svg width=\\"" +svgEl.getAttribute("width")+ "\\" height=\\"" +svgEl.getAttribute("height")+ "\\" viewBox=\\"0 0 24 24\\" fill=\\"none\\" stroke=\\"currentColor\\" stroke-width=\\"1.5\\" stroke-linecap=\\"round\\" stroke-linejoin=\\"round\\"><ellipse cx=\\"12\\" cy=\\"5\\" rx=\\"9\\" ry=\\"3\\"/><path d=\\"M3 5V19A9 3 0 0 0 21 19V5\\"/><path d=\\"M3 12A9 3 0 0 0 21 12\\"/></svg>";}
        var spans=btn.querySelectorAll("span");
        for(var j=0;j<spans.length;j++){if(spans[j].textContent.trim()==="All docs"){spans[j].textContent="Database";break;}}
        btn.onclick=function(e){e.preventDefault();e.stopPropagation();window.location.href="https://franwatch.com:8443"};
        anchor.parentElement.insertBefore(btn,anchor);
      }
      function autoEnableCloud(){
        var btns=document.querySelectorAll("button,div[role=\\"button\\"]");
        for(var k=0;k<btns.length;k++){
          var txt=btns[k].textContent.trim();
          if(txt.indexOf("Enable AFFiNE Cloud")!==-1){btns[k].click();return;}
          if(txt==="Enable"&&btns[k].closest("[role=\\"dialog\\"],dialog,[class*=\\"modal\\"]")){btns[k].click();return;}
        }
        var banner=document.querySelector("[class*=\\"local-data\\"],div[style*=\\"background\\"]");
        if(!banner){var allDivs=document.querySelectorAll("div");for(var m=0;m<allDivs.length;m++){if(allDivs[m].textContent.indexOf("stored in the browser")!==-1&&allDivs[m].offsetHeight<80){allDivs[m].style.display="none";break;}}}
      }
      function run(){injectSidebarBtn();autoEnableCloud();setTimeout(run,500)}
      if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",run)}else{run()}
    })();
    </script></head>';

    location / {
        proxy_pass http://affine:3010;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ─── NocoDB (HTTPS 8443) ────────────────────────────────────────────
server {
    listen 8443 ssl;
    server_name _;
    client_max_body_size 100m;

    ssl_certificate /etc/letsencrypt/live/franwatch.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/franwatch.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;
    proxy_set_header Accept-Encoding "";
    sub_filter_once on;
    sub_filter_types text/html;

    sub_filter '</head>' '<script>
    (function(){
      function injectSidebarBtn(){
        if(document.getElementById("gvh-wiki-btn"))return;
        var nc=document.querySelector("[data-testid=\\"nc-mini-sidebar\\"]")||document.querySelector(".nc-mini-sidebar");
        if(!nc){var els=document.querySelectorAll("div,nav,aside");for(var i=0;i<els.length;i++){var s=window.getComputedStyle(els[i]);if(parseInt(s.width)<=60&&parseInt(s.height)>300&&s.display==="flex"&&s.flexDirection==="column"){nc=els[i];break;}}}
        if(!nc)return;
        var icons=nc.querySelectorAll("div[class],a[class]");
        var ref=null;
        for(var i=0;i<icons.length;i++){if(icons[i].querySelector("svg")&&icons[i].offsetWidth>=30&&icons[i].offsetWidth<=50){ref=icons[i];break;}}
        if(!ref)return;
        var bellItem=null;
        var allInSb=nc.querySelectorAll("*");
        for(var k=0;k<allInSb.length;k++){var el=allInSb[k];var r=el.getBoundingClientRect();if(r.width>2&&r.width<14&&r.height>2&&r.height<14){var bg=window.getComputedStyle(el).backgroundColor;if(bg&&bg!=="rgba(0, 0, 0, 0)"&&bg!=="transparent"&&bg!=="rgb(255, 255, 255)"){var p=el;while(p&&p.parentElement!==nc){p=p.parentElement;}if(p){bellItem=p;}break;}}}
        var btn=ref.cloneNode(false);
        btn.id="gvh-wiki-btn";
        btn.title="Wiki";
        btn.className=ref.className;
        btn.style.cursor="pointer";
        btn.innerHTML="<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"22\\" height=\\"22\\" viewBox=\\"0 0 24 24\\" fill=\\"none\\" stroke=\\"currentColor\\" stroke-width=\\"1.5\\" stroke-linecap=\\"round\\" stroke-linejoin=\\"round\\"><path d=\\"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20\\"/><line x1=\\"9\\" y1=\\"7\\" x2=\\"16\\" y2=\\"7\\"/><line x1=\\"9\\" y1=\\"11\\" x2=\\"14\\" y2=\\"11\\"/></svg>";
        btn.onclick=function(e){e.preventDefault();e.stopPropagation();window.location.href="https://franwatch.com"};
        if(bellItem&&bellItem.nextElementSibling){nc.insertBefore(btn,bellItem.nextElementSibling)}
        else{var second=nc.children[1]||nc.children[0];if(second){nc.insertBefore(btn,second)}else{nc.appendChild(btn)}}
      }
      function run(){injectSidebarBtn();setTimeout(run,2000)}
      if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",run)}else{run()}
    })();
    </script></head>';

    location / {
        proxy_pass http://nocodb:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
